<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>English Vocabulary Online Test</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .question { margin-bottom: 20px; }
    .feedback { font-weight: bold; }
    .correct { color: green; }
    .incorrect { color: red; }
    .unanswered { color: orange; }
    .hidden { display: none; }
    table, th, td { border: 1px solid black; border-collapse: collapse; padding: 5px; }
    th { background-color: #f2f2f2; }
    #userInfo input { margin: 5px 0; }
    #userInfo label { display: block; margin-bottom: 10px; }
    #retryBtn { margin-top: 20px; }
  </style>
</head>
<body>
  <h1>English Vocabulary Online Test</h1>
  <div id="userInfo">
    <label>Class: <input type="text" id="userClass" required /></label>
    <label>Number: <input type="text" id="userNumber" required /></label>
    <label>Name: <input type="text" id="userName" required /></label>
    <button id="startBtn">Start Quiz</button>
  </div>
  <div id="quizSection" class="hidden">
    <p id="timer">Time left: 15:00</p>
    <form id="quizForm"></form>
    <button id="submitBtn">Submit</button>
    <div id="result" class="hidden"></div>
    <div id="scoreTable"></div>
    <div id="reviewSection" class="hidden">
      <h3>錯誤題目回顧</h3>
      <div id="reviewContent"></div>
    </div>
    <button id="retryBtn">🔁 重新測驗</button>
  </div>
  <script>
    const items = [...Array(50)].map((_, i) => ({
      audio: `chunk_${String(i + 1).padStart(2, '0')}.mp3`,
      word: ['pet','pit','jet','net','sit','hit','fix','fox','six','mix','ox','box','bear','monkey','tiger','lion','horse','goat','sing','dance','read','write','draw','can','can\'t','Goodbye.','See you.','I\'m sorry.','That\'s OK.','do','for','them','How about…?','show','have','great','Time to go home.','today','mom','mommy','mother','card','flower','cake','Happy Mother\'s Day.','on','Don\'t worry.','let\'s','here is…','I love you.'][i]
    }));

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    let selectedItems, choiceItems, typingItems, timerStartTime, totalTime = 15 * 60;

    document.getElementById('startBtn').addEventListener('click', () => {
      const userClass = document.getElementById('userClass').value.trim();
      const userNumber = document.getElementById('userNumber').value.trim();
      const userName = document.getElementById('userName').value.trim();
      if (!userClass || !userNumber || !userName) {
        alert('請完整填寫班級、座號與姓名再開始測驗。');
        return;
      }
      document.getElementById('userInfo').classList.add('hidden');
      document.getElementById('quizSection').classList.remove('hidden');
      startTimer();
      buildQuiz();
    });

    function startTimer() {
      timerStartTime = Date.now();
      const timerElement = document.getElementById('timer');
      const interval = setInterval(() => {
        const minutes = Math.floor(totalTime / 60);
        const seconds = totalTime % 60;
        timerElement.textContent = `Time left: ${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
        totalTime--;
        if (totalTime < 0) {
          clearInterval(interval);
          document.getElementById('submitBtn').click();
        }
      }, 1000);
    }

    function buildQuiz() {
      selectedItems = shuffle([...items]).slice(0, 20);
      choiceItems = selectedItems.slice(0, 10);
      typingItems = selectedItems.slice(10);
      const quizForm = document.getElementById('quizForm');
      quizForm.innerHTML = '';

      [...choiceItems, ...typingItems].forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'question';

        const audio = document.createElement('audio');
        audio.src = item.audio;
        audio.controls = true;
        audio.dataset.playCount = 0;
        audio.addEventListener('play', () => {
          const count = parseInt(audio.dataset.playCount);
          if (count >= 2) {
            audio.pause();
            audio.currentTime = 0;
            alert('此題音檔已播放兩次，無法再播放。');
          } else {
            audio.dataset.playCount = count + 1;
          }
        });

        div.appendChild(document.createTextNode(`Q${index + 1}: `));
        div.appendChild(audio);
        div.appendChild(document.createElement('br'));

        if (index < 10) {
          const options = shuffle([item.word, ...shuffle(items.filter(i => i.word !== item.word).map(i => i.word)).slice(0, 3)]);
          options.forEach(option => {
            const label = document.createElement('label');
            const radio = document.createElement('input');
            radio.type = 'radio';
            radio.name = `answer_${index}`;
            radio.value = option;
            label.appendChild(radio);
            label.appendChild(document.createTextNode(option));
            div.appendChild(label);
            div.appendChild(document.createElement('br'));
          });
        } else {
          const input = document.createElement('input');
          input.type = 'text';
          input.name = `answer_${index}`;
          input.placeholder = 'Type your answer';
          div.appendChild(input);
        }

        const feedback = document.createElement('div');
        feedback.className = 'feedback';
        feedback.id = `feedback_${index}`;
        div.appendChild(feedback);
        quizForm.appendChild(div);
      });
    }

    document.getElementById('submitBtn').addEventListener('click', () => {
      const elapsed = Math.floor((Date.now() - timerStartTime) / 1000);
      const minutes = Math.floor(elapsed / 60);
      const seconds = elapsed % 60;
      const timeSpent = `${minutes}分${seconds}秒`;

      let score = 0, correctCount = 0, incorrectCount = 0, unansweredCount = 0;
      let wrongItems = [];

      [...choiceItems, ...typingItems].forEach((item, index) => {
        const radios = document.querySelectorAll(`[name='answer_${index}']`);
        let userAnswer = '';
        if (radios.length > 1) {
          const checked = [...radios].find(r => r.checked);
          if (checked) userAnswer = checked.value.trim().toLowerCase();
        } else if (radios.length === 1) {
          userAnswer = radios[0].value.trim().toLowerCase();
        }

        const feedback = document.getElementById(`feedback_${index}`);
        const correctAnswer = item.word.toLowerCase();

        if (!userAnswer) {
          unansweredCount++;
          feedback.textContent = `? 未作答，正確答案為：${item.word}`;
          feedback.className = 'feedback unanswered';
          wrongItems.push(item);
        } else if (userAnswer === correctAnswer) {
          score += 5;
          correctCount++;
          feedback.textContent = '✅ 答對';
          feedback.className = 'feedback correct';
        } else {
          incorrectCount++;
          feedback.textContent = `❌ 答錯，正確答案為：${item.word}`;
          feedback.className = 'feedback incorrect';
          wrongItems.push(item);
        }
      });

      document.getElementById('result').classList.remove('hidden');
      document.getElementById('result').textContent = `你獲得 ${score} 分。`;

      document.getElementById('scoreTable').innerHTML = `
        <h3>測驗結果分析</h3>
        <table>
          <tr><th>類別</th><th>數量</th></tr>
          <tr><td>答對</td><td>${correctCount}</td></tr>
          <tr><td>答錯</td><td>${incorrectCount}</td></tr>
          <tr><td>未作答</td><td>${unansweredCount}</td></tr>
          <tr><td>總分</td><td>${score}</td></tr>
          <tr><td>作答時間</td><td>${timeSpent}</td></tr>
        </table>`;

      const review = document.getElementById('reviewContent');
      review.innerHTML = '';
      wrongItems.forEach((item, idx) => {
        const div = document.createElement('div');
        const audio = document.createElement('audio');
        audio.src = item.audio;
        audio.controls = true;
        div.appendChild(document.createTextNode(`錯題 ${idx + 1}: `));
        div.appendChild(audio);
        div.appendChild(document.createTextNode(` 正確答案：${item.word}`));
        review.appendChild(div);
      });
      document.getElementById('reviewSection').classList.remove('hidden');

      const payload = {
        class: document.getElementById('userClass').value,
        number: document.getElementById('userNumber').value,
        name: document.getElementById('userName').value,
        score: score,
        correct: correctCount,
        incorrect: incorrectCount,
        unanswered: unansweredCount,
        timeSpent: timeSpent
      };

      fetch('https://script.google.com/macros/s/AKfycbwAwplm85QyLQUWtUnvNFhje6wodzF3cz71oNlAh-TJtOxYWKoY_ceoBJH7ORxsEB-Z/exec', {
        method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify(payload)
})

    });

    document.getElementById('retryBtn').addEventListener('click', () => {
      document.getElementById('quizForm').innerHTML = '';
      document.getElementById('result').classList.add('hidden');
      document.getElementById('scoreTable').innerHTML = '';
      document.getElementById('reviewContent').innerHTML = '';
      document.getElementById('reviewSection').classList.add('hidden');
      document.getElementById('userInfo').classList.remove('hidden');
      document.getElementById('quizSection').classList.add('hidden');
      totalTime = 15 * 60;
      timerStartTime = null;
      document.getElementById('userClass').value = '';
      document.getElementById('userNumber').value = '';
      document.getElementById('userName').value = '';
    });
  </script>
</body>
</html>
